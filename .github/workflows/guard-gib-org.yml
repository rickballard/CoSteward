name: guard-gib-org
on:
  pull_request:
    types: [opened, synchronize, reopened, edited]
jobs:
  guard:
    runs-on: ubuntu-latest
    permissions: { pull-requests: write, contents: read }
    steps:
      - uses: actions/checkout@v4
      - name: Block junk folders and enforce GIB tag on Co* tokens
        shell: pwsh
        run: |
          $bad = git diff --name-only origin/main...HEAD | ? { $_ -match '^(insight/|insights/|docs/insight/)' }
          if($bad){ Write-Error "Forbidden folders present:`n$($bad -join "`n")" }
          $added = git diff --unified=0 origin/main...HEAD | Select-String '^\+'
          $co = $added | ? { $_.Line -match '\bCo[A-Z]\w*' } | % Line
          if($co){
            $hasTag = ($added | % Line) -match 'gib:Term' | Select-Object -First 1
            if(-not $hasTag){ Write-Error "New Co* token(s) introduced but no 'gib:Term' reference found." }
          }
- name: Explain guard failure (PR comment)
  if: ${{ failure() && github.event_name == 'pull_request' }}
  shell: bash
  env:
    PR_NUMBER: ${{ github.event.pull_request.number }}
  run: |
    body=$'# ❌ PR blocked by org guard\n\n**Why**\n- Forbidden folders: `docs/insight/` / `insights/`\n- New `Co*` tokens require a `gib:Term` reference in the diff\n\n**Fix**\nPush a commit that removes forbidden paths and/or adds the `gib:Term` reference.'
    gh pr comment "$PR_NUMBER" -b "$body" || true
param()
$ErrorActionPreference='Stop'
$wf = ".github/workflows/guard-gib-org.yml"
git fetch origin
$br = "ci/guard-comment-"+(Get-Date -AsUTC).ToString('yyyyMMdd_HHmmssZ')
git switch -c $br origin/main

$yaml = Get-Content $wf -Raw
if($yaml -notmatch 'Explain guard failure \(PR comment\)'){
@'
- name: Explain guard failure (PR comment)
  if: ${{ failure() && github.event_name == 'pull_request' }}
  shell: bash
  env:
    PR_NUMBER: ${{ github.event.pull_request.number }}
  run: |
    body=$'# ❌ PR blocked by org guard\n\n**Why**\n- Forbidden folders: `docs/insight/` / `insights/`\n- New `Co*` tokens require a `gib:Term` reference in the diff\n\n**Fix**\nPush a commit that removes forbidden paths and/or adds the `gib:Term` reference.'
    gh pr comment "$PR_NUMBER" -b "$body" || true
param()
$ErrorActionPreference='Stop'

$wf = ".github/workflows/guard-gib-org.yml"
if(!(Test-Path $wf)){ throw "Missing $wf" }

git fetch origin | Out-Null
$br = "ci/guard-comment-"+(Get-Date -AsUTC).ToString('yyyyMMdd_HHmmssZ')
git switch -c $br origin/main | Out-Null

$yaml = Get-Content $wf -Raw
if($yaml -notmatch 'Explain guard failure \(PR comment\)'){
@'
- name: Explain guard failure (PR comment)
  if: ${{ failure() && github.event_name == 'pull_request' }}
  shell: bash
  env:
    PR_NUMBER: ${{ github.event.pull_request.number }}
  run: |
    body=$'# ❌ PR blocked by org guard\n\n**Why**\n- Forbidden folders: `docs/insight/` / `insights/`\n- New `Co*` tokens require a `gib:Term` reference in the diff\n\n**Fix**\nPush a commit that removes forbidden paths and/or adds the `gib:Term` reference.'
    gh pr comment "$PR_NUMBER" -b "$body" || true
