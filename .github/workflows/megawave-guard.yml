name: MegaWave Guard
on: [pull_request]
jobs:
  guard:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with: { fetch-depth: 0 }
      - name: Validate MegaWave invariants
        shell: pwsh
        run: |
          $ErrorActionPreference='Stop'
          git fetch origin +refs/heads/${{ github.base_ref }}:refs/remotes/origin/${{ github.base_ref }}
          $base = "origin/${{ github.base_ref }}"
          $changed = git diff --name-only $base...HEAD

          # 1) at least one manifest.json present in repo (any session)
          $hasManifest = Test-Path -Path 'docs/intent/sessions/*/manifest.json'
          if(-not $hasManifest){ throw "Missing session manifest (docs/intent/sessions/<id>/manifest.json)" }

          # 2) if docs/ops or README touched → require a receipt with CoBloat heartbeat
          if($changed -match '^docs/ops/|^README\.md'){
            $today = Get-Date -Format 'yyyyMMdd'
            $receipts = Get-ChildItem -Recurse -File "docs/intent/advice/notes/$today" -EA SilentlyContinue
            if(-not $receipts){ throw "No receipt found under docs/intent/advice/notes/$today" }
            $ok = $false
            foreach($r in $receipts){
              $t = Get-Content -Raw $r.FullName
              if($t -match 'CoBloat.+CU:.+PU:.+HU:.+WT:'){ $ok = $true; break }
            }
            if(-not $ok){ throw "Receipt exists but CoBloat heartbeat missing (CU/PU/HU/WT)" }
          }

          Write-Host "✅ MegaWave guard passed."